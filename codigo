With
ponderado AS ( 
SELECT 
  CODMES_COSECHA, SUM(MTODEUDA),SUM(mtogastoprovsol), -- CTDMESMADURACION,
  SUM(numpdcalibrado * MTODEUDA) / SUM(MTODEUDA) AS pdponderado --0.020711 202501
FROM calculadorabase
WHERE 
  CODMES_COSECHA >= 202401 AND 
  CTDMESMADURACION = 0  
GROUP BY 
  CODMES_COSECHA, CTDMESMADURACION order by 1 desc)

SELECT 
  a.CODMES_COSECHA, 
  a.dessubsegmentobcarbmper AS segmento,
  a.CTDMESMADURACION,
  SUM(a.MTODEUDA) AS sum_mtodeuda,
  SUM(a.mtogastoprovsol) AS sum_mtogastoprovsol,
  b.pdponderado,
  CASE 
    when  b.pdponderado >= 0.102 THEN '1. Muy Alto'
    when  b.pdponderado >= 0.074 THEN '2. Alto'
    when  b.pdponderado >= 0.049 THEN '3. Medio II'
    when  b.pdponderado >= 0.023 THEN '4 Medio I'
    when  b.pdponderado >= 0.014 THEN '5. Bajo II'
    when  b.pdponderado >= 0.006 THEN '6. Bajo I'
    when  b.pdponderado >= 0 THEN '7. Muy Bajo' else '8. no pd' end as rango_pd
FROM 
  calculadorabase a 
  LEFT JOIN ponderado b ON a.CODMES_COSECHA = b.CODMES_COSECHA
  where a.codmes_cosecha >=202401
GROUP BY 
  a.CODMES_COSECHA, 
  a.CTDMESMADURACION, 
  b.pdponderado, segmento, rango_pd
order by CODMES_COSECHA asc
