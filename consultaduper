WITH
calendario AS (
    SELECT CODMES, CODMES_ANTERIOR
    FROM catalog_lhcl_prod_bcp.bcp_edv_rbm.PROYECCION_DIAS),

max_fechas AS (
    SELECT
        CODCLAVECTA,TIPBLOQUEOCREDITOPERSONAL,
        DATE_FORMAT(FECSALDO, 'yyyyMM') AS CODMES, MAX(FECSALDO) AS FECHA_MAX
    FROM catalog_lhcl_prod_bcp.bcp_udv_int_vU.h_saldocuentacreditopersonal
    GROUP BY CODCLAVECTA, DATE_FORMAT(FECSALDO, 'yyyyMM'), TIPBLOQUEOCREDITOPERSONAL ),

base AS (
    SELECT a.*,
        case when c.TIPBLOQUEOCREDITOPERSONAL is null THEN '0.Sin bloqueo'
             WHEN c.TIPBLOQUEOCREDITOPERSONAL= 'R' THEN '1.Refinanciado'
             WHEN c.TIPBLOQUEOCREDITOPERSONAL= 'U' THEN '2.Prejudicial'
             WHEN c.TIPBLOQUEOCREDITOPERSONAL= 'Y' THEN '3.Judicial'
             WHEN c.TIPBLOQUEOCREDITOPERSONAL = 'E9CA' THEN '4.Castigos'
             ELSE '5.Otro bloqueo'
             END AS BLOQUEOCREDITOPERSONAL,
        CASE WHEN b.codinternocomputacional IS NOT NULL THEN 1 ELSE 0 END AS flag_duper,
        CASE WHEN a.montogarp = 0 THEN 0
             WHEN a.montogarp IS NULL THEN 0
             ELSE 1 END AS FLAG_GARANTIA,
        CASE WHEN a.TRAMO_MORA = '0.<0>' then 1
            WHEN a.TRAMO_MORA = '0.<1-8>' then 2
            WHEN a.TRAMO_MORA = '1.<9-30>' then 3
            WHEN a.TRAMO_MORA = '2.<31-60>' then 4
            WHEN a.TRAMO_MORA = '3.<61-90>' then 5
            WHEN a.TRAMO_MORA = '4.<91-120>' then 6
            WHEN a.TRAMO_MORA = '5.<121-150>' then 7
            WHEN a.TRAMO_MORA = '6.>=151' then 8
            WHEN a.TRAMO_MORA = 'CANCELACION' then 9
        END AS TRAMO_NUMERICO
    FROM catalog_lhcl_prod_bcp.bcp_edv_rbm.rbmconsolidadomigradoconcodclavectaMALLA a
    LEFT JOIN catalog_lhcl_prod_bcp.bcp_edv_rbm.T65734_HST b
      ON a.codinternocomputacional = b.codinternocomputacional
     AND a.codmes = b.codmes
     LEFT JOIN max_fechas c 
     ON a.codclavecta = c.codclavecta
     AND a.codmes = c.CODMES)

select*from base
