%let codmes=202508; 
%LET DBRICKS_MAX_TEXT = 128; /*Longitud maxima que se limitara los textos si el campo es string*/

%let codmes = 202508;
%let DBRICKS_MAX_TEXT = 128;
%let usr = T04809;
%let passw = Rvw$$2051sl;
%let bd = BCPDW3;  		"/sasdata01/RBM_SEG_DESA_04/T56309/Data/SSFF";

libname ods_v ORACLE user=&usr pass="&passw" path=BCPDW3 schema=ods_v;

proc import datafile="/sasdata31/RBM_SEG_DESA_04/T65734/tercio/temp_grado_sos.csv"
    out=work.temp_grado_sos01
    dbms=csv
    replace;
    guessingrows=MAX; /* o un nÃºmero alto como 10000 */
    getnames=yes;
run;
proc sql;
create table temp_grado_sos as select distinct 
trim(codinternocomputacional) as codinternocomputacional,
trim(numsolicitudmic) as numsolicitudmic, 
trim(GRADO_SOSTENIBILIDAD) as GRADO_SOSTENIBILIDAD 
FROM temp_grado_sos01;
quit;
/*
PROC SQL NOPRINT NOFEEDBACK;
CONNECT USING LIBDBTR;
CREATE TABLE temp_grado_sos AS
SELECT * FROM CONNECTION TO LIBDBTR (
	SELECT distinct trim(codinternocomputacional) as codinternocomputacional,
trim(numsolicitudmic) as numsolicitudmic, trim(GRADO_SOSTENIBILIDAD) as GRADO_SOSTENIBILIDAD
from catalog_lhcl_prod_bcp.bcp_edv_rbm.temp_grado_sos 
);
DISCONNECT FROM LIBDBTR;
QUIT;  		*/

/*generacion de creditos mivivienda - universo*/

proc sql;
create table MiVivienda_Garantias_0 as
select DISTINCT  a.CODCLAVEOPECTA,
       a.codopecta,
	   a.CODCLAVECIC,
	   b.CODOPECTAGAR,
	   c.TIPESTGAR,
	   D.CODTIPPRESTAMO,
	   D.FECDESEMBOLSOORIGINAL,
	   INPUT(COMPRESS(CODSOLICITUDPRESTAMO),10.) as CODSOLICITUDPRESTAMO_n,
	   COMPRESS(NUMSOLICITUD) AS NUMSOLICITUD,
	   MTOBIENADQUIRIR,
	   CASE WHEN SUBSTR(CODSOLICITUDPRESTAMO,1,2)='CC' THEN 1 ELSE 0 END AS FLG_CC
  from (select * from ods_v.hm_resumensaldo where codmes = &codmes and 
codproducto in ('CPEHMM','CPEHMR','CPEHMV','CPEHTP','CPTM01','CPEHTR','CPEHMP') 
/*aqui validar en caso de que haya un nuevo tioaux mivivienda*/
) a
  left join ods_v.md_relacionprestamogarantia b
    on a.CODCLAVEOPECTA = b.CODCLAVEOPECTA and b.FLGREGELIMINADO = 'N'
  left join ods_v.md_garantia c
    on b.CODOPECTAGAR = c.CODOPECTAGAR and c.FLGREGELIMINADO = 'N'
LEFT JOIN ODS_V.MD_PRESTAMO D
ON A.CODCLAVEOPECTA=D.CODCLAVEOPECTA
LEFT JOIN ods_v.Md_Solicitud_Mic E
ON INPUT(COMPRESS(CODSOLICITUDPRESTAMO),10.)=E.CODSOLICITUD
WHERE D.CODTIPPRESTAMO IN ('HBIV','HITP','HMIV','HSIV','HVIV','HTIV')
;
quit;

proc sql;
create table MiVivienda_Garantias_01 as
SELECT A.*,grado_sostenibilidad FROM
MiVivienda_Garantias_0 A
LEFT JOIN temp_grado_sos B
ON COMPRESS(A.NUMSOLICITUD)=COMPRESS(B.NUMSOLICITUDMIC) AND A.NUMSOLICITUD IS NOT NULL;
QUIT;
proc sql;
create table MiVivienda_Garantias_1 as
select distinct
compress(b.CODINTERNOCOMPUTACIONAL) as CIC,
substr(b.CODDOC,5,8) as IDC,
b.TIPDOC as TIPO_IDC,
substr(compress(b.NBRCLI)||' '||compress(b.APEPATCLI)||' '||compress(b.APEMATCLI),1,40) as NOMBRES,
CASE WHEN FLG_CC=1 THEN 0.333333
     WHEN datepart(FECDESEMBOLSOORIGINAL)>='1jan2022'd then 
		case when MTOBIENADQUIRIR<=232200 then 
			   CASE when grado_sostenibilidad=('GRADO1') THEN 0.16670
				WHEN grado_sostenibilidad=('GRADO2') THEN 0.26670
				WHEN grado_sostenibilidad=('GRADO3') THEN 0.36670
				ELSE 0.066700 
			   END 
        	     when MTOBIENADQUIRIR>232200 then 
			   CASE when grado_sostenibilidad=('GRADO1') THEN 0.066700
				WHEN grado_sostenibilidad=('GRADO2') THEN 0.166700
				WHEN grado_sostenibilidad=('GRADO3') THEN 0.266700
				ELSE 0.000000 
			   END  
        	     ELSE 0.333333 
		END 
	ELSE 0.333333 
     END   
as COBERTURA_ADICIONAL
from MiVivienda_Garantias_01 a
left join ods_V.Md_Clienteg94 b on a.codclavecic=b.CODCLAVECIC and b.FLGREGELIMINADO = 'N'
where tipestgar = '10' and calculated COBERTURA_ADICIONAL>0;
quit;
proc export data=MiVivienda_Garantias_1
    outfile="/sasdata01/RBM_SEG_DESA_04/T65734/tercio/tercio2509.csv" 
    dbms=dlm
    replace;
    delimiter=";";
run;
