WITH base AS (
  SELECT
    CODMES_COSECHA,
    dessubsegmentobcarbmper AS segmento,
    CTDMESMADURACION AS maduracion,
    SUM(MTODEUDA) AS saldo,
    SUM(MTOGASTOPROVSOL) AS provision,
    SUM(NUMPDCALIBRADO * MTODEUDA) / SUM(MTODEUDA) AS pdponderado
  FROM calculadorabase
  WHERE CODMES_COSECHA >= 202401
  GROUP BY CODMES_COSECHA, dessubsegmentobcarbmper, CTDMESMADURACION
),

totales AS (
  SELECT
    CODMES_COSECHA,
    SUM(CASE WHEN CTDMESMADURACION = 0 THEN saldo ELSE 0 END) AS total_mto_cosecha
  FROM base
  GROUP BY CODMES_COSECHA
)

SELECT
  b.CODMES_COSECHA,
  b.segmento,
  b.maduracion,
  b.saldo,
  b.provision,
  b.pdponderado,

  -- peso del segmento dentro del total de la cosecha (maduraciÃ³n 0)
  CASE 
    WHEN b.maduracion = 0 THEN ROUND(b.saldo / t.total_mto_cosecha, 4)
    ELSE NULL
  END AS peso_segmento,

  -- rango de riesgo por pdponderado
  CASE
    WHEN b.pdponderado >= 0.08 THEN 'Muy alto'
    WHEN b.pdponderado >= 0.05 THEN 'Alto'
    WHEN b.pdponderado >= 0.02 THEN 'Medio'
    WHEN b.pdponderado >  0   THEN 'Bajo'
    ELSE 'Sin riesgo'
  END AS rango_pd

FROM base b
LEFT JOIN totales t 
  ON b.CODMES_COSECHA = t.CODMES_COSECHA
ORDER BY
  b.CODMES_COSECHA,
  b.segmento,
  b.maduracion;
