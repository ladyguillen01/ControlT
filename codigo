WITH ponderado AS (
  SELECT 
    CODMES_COSECHA,
    dessubsegmentobcarbmper AS segmento,
    SUM(MTODEUDA) AS sum_mtodeuda_segmento,
    SUM(mtogastoprovsol) AS sum_mtogastoprovsol_segmento,
    SUM(numpdcalibrado * MTODEUDA) / SUM(MTODEUDA) AS pdponderado_segmento
  FROM calculadorabase
  WHERE 
    CODMES_COSECHA >= 202401 
    AND CTDMESMADURACION = 0  
  GROUP BY CODMES_COSECHA, dessubsegmentobcarbmper
),

totales AS (
  SELECT
    CODMES_COSECHA,
    SUM(sum_mtodeuda_segmento) AS total_mtodeuda
  FROM ponderado
  GROUP BY CODMES_COSECHA
)

SELECT
  p.CODMES_COSECHA,

  -- porcentaje que representa cada segmento en la deuda inicial
  SUM(CASE WHEN p.segmento = 'BEex' THEN p.sum_mtodeuda_segmento ELSE 0 END) / t.total_mtodeuda * 100 AS pct_BEex,
  SUM(CASE WHEN p.segmento = 'Enalta' THEN p.sum_mtodeuda_segmento ELSE 0 END) / t.total_mtodeuda * 100 AS pct_Enalta,
  SUM(CASE WHEN p.segmento = 'Bmedia' THEN p.sum_mtodeuda_segmento ELSE 0 END) / t.total_mtodeuda * 100 AS pct_Bmedia,
  SUM(CASE WHEN p.segmento = 'Baja' THEN p.sum_mtodeuda_segmento ELSE 0 END) / t.total_mtodeuda * 100 AS pct_Baja,
  SUM(CASE WHEN p.segmento = 'Consumo B' THEN p.sum_mtodeuda_segmento ELSE 0 END) / t.total_mtodeuda * 100 AS pct_ConsumoB,

  -- pd ponderado total de la cosecha
  SUM(p.sum_mtodeuda_segmento * p.pdponderado_segmento) / SUM(p.sum_mtodeuda_segmento) AS pdponderado_total

FROM ponderado p
JOIN totales t 
  ON p.CODMES_COSECHA = t.CODMES_COSECHA
GROUP BY 
  p.CODMES_COSECHA, 
  t.total_mtodeuda
ORDER BY 
  p.CODMES_COSECHA ASC;
