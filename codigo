WITH base AS (
  SELECT
    CODMES_COSECHA AS COSECHA,
    dessubsegmentobcarbmper AS segmento,
    CTDMESMADURACION AS maduracion,
    SUM(MTODEUDA) AS saldo,
    SUM(MTOGASTOPROVSOL) AS provision,
    SUM(NUMPDCALIBRADO * MTODEUDA) / SUM(MTODEUDA) AS pdponderado
  FROM calculadorabase
  WHERE CODMES_COSECHA >= 202401
  GROUP BY CODMES_COSECHA, dessubsegmentobcarbmper, CTDMESMADURACION
),

-- pesos de los segmentos calculados solo para maduración 0
pesos AS (
  SELECT
    COSECHA,
    dessubsegmentobcarbmper AS segmento,
    SUM(saldo) / SUM(SUM(saldo)) OVER (PARTITION BY COSECHA) AS peso_segmento
  FROM base
  WHERE maduracion = 0
  GROUP BY COSECHA, dessubsegmentobcarbmper
),

final AS (
  SELECT 
    b.COSECHA,
    b.maduracion,
    SUM(b.saldo) AS saldo,
    SUM(b.provision) AS provision,
    MAX(b.pdponderado) AS pdponderado,
    CASE
      WHEN MAX(b.pdponderado) >= 0.08 THEN 'Muy alto'
      WHEN MAX(b.pdponderado) >= 0.05 THEN 'Alto'
      WHEN MAX(b.pdponderado) >= 0.02 THEN 'Medio'
      WHEN MAX(b.pdponderado) >  0   THEN 'Bajo'
      ELSE 'Sin riesgo'
    END AS rango_pd,

    -- pivot dinámico de los segmentos
    SUM(CASE WHEN p.segmento = '01. Enalta/Privada' THEN p.peso_segmento ELSE 0 END) AS "Enalta/Privada",
    SUM(CASE WHEN p.segmento = '02. Bex' THEN p.peso_segmento ELSE 0 END) AS "Bex",
    SUM(CASE WHEN p.segmento = '03. Consumo A' THEN p.peso_segmento ELSE 0 END) AS "Consumo A",
    SUM(CASE WHEN p.segmento = '04. Consumo B' THEN p.peso_segmento ELSE 0 END) AS "Consumo B",
    SUM(CASE WHEN p.segmento = '05. Consumo C' THEN p.peso_segmento ELSE 0 END) AS "Consumo C",
    SUM(CASE WHEN p.segmento = '06. Consumo Otros' THEN p.peso_segmento ELSE 0 END) AS "Consumo Otros",
    SUM(CASE WHEN p.segmento = '07. Pyme' THEN p.peso_segmento ELSE 0 END) AS "Pyme",
    SUM(CASE WHEN p.segmento = '08. No Banco' THEN p.peso_segmento ELSE 0 END) AS "No Banco",
    SUM(CASE WHEN p.segmento = '09. Gremio' THEN p.peso_segmento ELSE 0 END) AS "Gremio",
    SUM(CASE WHEN p.segmento = '98. Otros' THEN p.peso_segmento ELSE 0 END) AS "Otros",
    SUM(CASE WHEN p.segmento = '99. Missing' THEN p.peso_segmento ELSE 0 END) AS "Missing"

  FROM base b
  LEFT JOIN pesos p ON b.COSECHA = p.COSECHA
  GROUP BY b.COSECHA, b.maduracion
)

SELECT * FROM final
ORDER BY COSECHA, maduracion;
